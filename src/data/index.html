<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TigoServer ¬∑ PV Monitor</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0d0d0d;
      --surface: #1a1a1a;
      --border:  #2e2e2e;
      --accent:  #f0a500;
      --green:   #4caf50;
      --blue:    #42a5f5;
      --red:     #ef5350;
      --text:    #e0e0e0;
      --muted:   #777;
      --radius:  12px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      padding: 14px;
    }

    /* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 16px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .nav-links { display: flex; gap: 4px; flex-wrap: wrap; }
    nav a {
      color: var(--text);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      padding: 5px 11px;
      border-radius: 7px;
      transition: background .18s;
    }
    nav a:hover { background: var(--border); }
    nav a.danger { color: var(--red); }
    nav a.danger:hover { background: rgba(239,83,80,.13); }

    /* ‚îÄ‚îÄ WS status ‚îÄ‚îÄ */
    .ws-status { display: flex; align-items: center; gap: 7px; }
    #status-dot {
      width: 9px; height: 9px;
      border-radius: 50%;
      background: var(--red);
      flex-shrink: 0;
      transition: background .4s, box-shadow .4s;
    }
    #status-dot.on {
      background: var(--green);
      box-shadow: 0 0 7px var(--green);
    }
    #status-label { font-size: 0.8rem; color: var(--muted); }

    /* ‚îÄ‚îÄ Summary pills ‚îÄ‚îÄ */
    #summary {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .pill {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 9px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 100px;
    }
    .pill .pval {
      font-size: 1.45rem;
      font-weight: 800;
      line-height: 1.1;
      color: var(--accent);
    }
    .pill .plbl {
      font-size: 0.68rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .07em;
      margin-top: 1px;
    }
    .pill.c-green .pval { color: var(--green); }
    .pill.c-blue  .pval { color: var(--blue);  }

    /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(205px, 1fr));
      gap: 12px;
    }

    /* ‚îÄ‚îÄ Module card ‚îÄ‚îÄ */
    .module {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 14px 11px;
      display: flex;
      flex-direction: column;
      gap: 9px;
      position: relative;
      overflow: hidden;
      transition: transform .15s, opacity .4s;
    }
    .module:hover { transform: translateY(-2px); }
    .module.stale { opacity: .45; }

    /* coloured left bar */
    .module::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 4px;
      background: var(--bar-color, var(--border));
      transition: background .5s;
    }

    /* RSSI badge top-right */
    .rssi-badge {
      position: absolute;
      top: 9px; right: 9px;
      font-size: 0.62rem;
      font-weight: 700;
      padding: 2px 5px;
      border-radius: 4px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }

    .mod-id {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: .04em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: calc(100% - 60px);
    }

    .watt-row {
      display: flex;
      align-items: baseline;
      gap: 5px;
    }
    .watt-val {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1;
      color: var(--text);
    }
    .watt-unit { font-size: 0.82rem; color: var(--muted); }

    /* watt progress bar */
    .wbar-wrap {
      height: 4px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    .wbar {
      height: 100%;
      background: var(--bar-color, var(--accent));
      border-radius: 3px;
      transition: width .55s ease;
      width: 0%;
    }

    /* 2-col metrics */
    .metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 8px;
    }
    .metric { display: flex; flex-direction: column; }
    .metric .ml { font-size: 0.62rem; color: var(--muted); text-transform: uppercase; letter-spacing: .04em; }
    .metric .mv { font-size: 0.78rem; font-weight: 600; color: var(--text); }
    .metric .mv.blue { color: var(--blue); }

    /* barcode row */
    .barcode-row {
      font-size: 0.65rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .barcode-row span { color: var(--text); font-weight: 600; }

    /* timestamp */
    .mod-ts {
      font-size: 0.6rem;
      color: #555;
      text-align: right;
    }

    /* ‚îÄ‚îÄ Charts section ‚îÄ‚îÄ */
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    @media (max-width: 700px) { .charts-row { grid-template-columns: 1fr; } }
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 14px 6px;
    }
    .chart-card h3 {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 8px;
    }
  </style>
  <!-- ApexCharts da CDN; se non disponibile (LAN senza internet) le chart vengono nascoste -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>

  <nav>
    <div class="nav-links">
      <a href="/debug">üß† Debug</a>
      <a href="/panels">üîñ Pannelli</a>
      <a href="/spiffs">üíæ SPIFFS</a>
      <a href="#" class="danger"
         onclick="if(confirm('Riavviare il dispositivo?'))fetch('/reboot',{method:'POST'}).then(()=>setTimeout(()=>location.reload(),5000))">
         üîÅ Reboot
      </a>
    </div>
    <div class="ws-status">
      <span id="status-dot"></span>
      <span id="status-label">Disconnected</span>
    </div>
  </nav>

  <div id="summary">
    <div class="pill">
      <span class="pval" id="s-total">0</span>
      <span class="plbl">Watt totali</span>
    </div>
    <div class="pill c-green">
      <span class="pval" id="s-count">0</span>
      <span class="plbl">Moduli</span>
    </div>
    <div class="pill c-blue">
      <span class="pval" id="s-avgvin">‚Äî</span>
      <span class="plbl">Vin medio</span>
    </div>
    <div class="pill c-blue">
      <span class="pval" id="s-avgtemp">‚Äî</span>
      <span class="plbl">Temp media</span>
    </div>
  </div>

  <div class="grid" id="container"></div>

  <!-- Charts -->
  <div class="charts-row" id="charts-row" style="margin-top:16px">
    <div class="chart-card">
      <h3>Potenza totale ‚Äî ultimi 60 campioni</h3>
      <div id="chart-power"></div>
    </div>
    <div class="chart-card">
      <h3>Potenza per pannello (W attuale)</h3>
      <div id="chart-panels"></div>
    </div>
  </div>

  <script>
    const socket    = new WebSocket(`ws://${location.host}/ws`);
    const container = document.getElementById('container');
    const modules   = {};   // id ‚Üí { el, lastUpdate }
    const data_map  = {};   // id ‚Üí last data object

    const MAX_WATT = 400;   // adatta al tuo impianto
    const STALE_MS = 90000; // ms senza aggiornamento ‚Üí card opaca

    // grey ‚Üí amber ‚Üí green
    function wattColor(w) {
      const f = Math.max(0, Math.min(1, w / MAX_WATT));
      if (f < 0.5) return lerpRGB([46,46,46], [240,165,0], f * 2);
      return lerpRGB([240,165,0], [76,175,80], (f - 0.5) * 2);
    }
    function lerpRGB(a, b, t) {
      return `rgb(${a.map((v,i)=>Math.round(v+t*(b[i]-v))).join(',')})`;
    }
    function timeStr() { return new Date().toLocaleTimeString(); }

    function createCard(key) {
      const el = document.createElement('div');
      el.className = 'module';
      el.innerHTML = `
        <div class="rssi-badge" id="rssi-${key}">‚Äî</div>
        <div class="mod-id" id="mid-${key}" title="${key}">${key}</div>
        <div class="watt-row">
          <span class="watt-val" id="wv-${key}">‚Äî</span>
          <span class="watt-unit">W</span>
        </div>
        <div class="wbar-wrap"><div class="wbar" id="wb-${key}"></div></div>
        <div class="metrics">
          <div class="metric">
            <span class="ml">Vin</span>
            <span class="mv blue" id="vin-${key}">‚Äî</span>
          </div>
          <div class="metric">
            <span class="ml">Vout</span>
            <span class="mv blue" id="vout-${key}">‚Äî</span>
          </div>
          <div class="metric">
            <span class="ml">Corrente</span>
            <span class="mv" id="amp-${key}">‚Äî</span>
          </div>
          <div class="metric">
            <span class="ml">Temp</span>
            <span class="mv" id="temp-${key}">‚Äî</span>
          </div>
        </div>
        <div class="barcode-row">SN: <span id="bc-${key}">‚Äî</span></div>
        <div class="mod-ts" id="ts-${key}"></div>
      `;
      el.dataset.label = key;
      container.appendChild(el);
      modules[key] = { el, lastUpdate: Date.now() };
      return modules[key];
    }

    function updateSummary() {
      const list = Object.values(data_map);
      const tot   = list.reduce((s,d) => s + (d.watt||0), 0);
      const avgV  = list.length ? list.reduce((s,d)=>s+(d.vin||0),0)/list.length : null;
      const avgT  = list.length ? list.reduce((s,d)=>s+(d.temp||0),0)/list.length : null;
      document.getElementById('s-total').textContent  = tot.toFixed(0);
      document.getElementById('s-count').textContent  = list.length;
      document.getElementById('s-avgvin').textContent  = avgV  != null ? avgV.toFixed(1)+'V'  : '‚Äî';
      document.getElementById('s-avgtemp').textContent = avgT  != null ? avgT.toFixed(1)+'¬∞C' : '‚Äî';
    }

    socket.onopen = () => {
      document.getElementById('status-dot').classList.add('on');
      document.getElementById('status-label').textContent = 'Live';
    };
    socket.onclose = () => {
      document.getElementById('status-dot').classList.remove('on');
      document.getElementById('status-label').textContent = 'Disconnected ‚Äì reconnecting‚Ä¶';
      setTimeout(() => location.reload(), 5000);
    };

    socket.onmessage = function(event) {
      try {
        const list = JSON.parse(event.data);
        list.forEach(d => {
          // Chiave stabile = addr corto (non cambia anche se assegni etichetta)
          const key = d.addr || d.id || 'mod#NA';
          let entry = modules[key];
          if (!entry) entry = createCard(key);

          data_map[key]      = d;
          entry.lastUpdate   = Date.now();
          entry.el.classList.remove('stale');

          // Etichetta visualizzata: panel > barcode > addr
          const displayName = d.panel || d.barcode || key;
          const g = s => document.getElementById(s + key);
          g('mid-').textContent  = displayName;
          g('mid-').title        = displayName + (d.panel ? ' (' + d.barcode + ')' : '');
          entry.el.dataset.label = displayName;

          const color = wattColor(d.watt || 0);
          const pct   = Math.min(100, ((d.watt||0) / MAX_WATT) * 100).toFixed(1);
          entry.el.style.setProperty('--bar-color', color);

          g('wv-'  ).textContent = d.watt ?? '‚Äî';
          g('wb-'  ).style.width = pct + '%';
          g('vin-' ).textContent = d.vin   != null ? d.vin.toFixed(2) +'V'  : '‚Äî';
          g('vout-').textContent = d.vout  != null ? d.vout.toFixed(2)+'V'  : '‚Äî';
          g('amp-' ).textContent = d.amp   != null ? d.amp.toFixed(2) +'A'  : '‚Äî';
          g('temp-').textContent = d.temp  != null ? d.temp.toFixed(1)+'¬∞C' : '‚Äî';
          g('rssi-').textContent = d.rssi  != null ? d.rssi+'dB'            : '‚Äî';
          g('bc-'  ).textContent = d.barcode || '‚Äî';
          g('ts-'  ).textContent = timeStr();
        });
        reorderCards();
        updateSummary();
        updateCharts();
      } catch(err) {
        console.error('WS parse error:', err);
      }
    };

    function reorderCards() {
      const cards = Array.from(container.children);
      cards.sort((a, b) =>
        (a.dataset.label || '').localeCompare(b.dataset.label || '', undefined, { numeric: true, sensitivity: 'base' })
      );
      cards.forEach(c => container.appendChild(c));
    }

    // segna le card "stale" ogni 10 s
    setInterval(() => {
      const now = Date.now();
      Object.values(modules).forEach(m => {
        m.el.classList.toggle('stale', now - m.lastUpdate > STALE_MS);
      });
    }, 10000);

    // ‚îÄ‚îÄ‚îÄ ApexCharts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const CHART_DARK = {
      background: 'transparent',
      foreColor: '#777',
      toolbar: { show: false },
      zoom: { enabled: false }
    };
    const GRID_OPTS = {
      borderColor: '#2e2e2e',
      strokeDashArray: 4
    };
    const TOOLTIP_DARK = {
      theme: 'dark',
      style: { fontSize: '11px' }
    };

    // --- Chart 1: total power time-series ---
    const powerHistory = [];   // { x: timestamp ms, y: totalW }
    const MAX_HIST = 60;

    const chartPowerOpts = {
      chart: { ...CHART_DARK, type: 'area', height: 180, animations: { enabled: true, easing: 'linear', dynamicAnimation: { speed: 800 } } },
      series: [{ name: 'Totale W', data: [] }],
      colors: ['#f0a500'],
      fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.35, opacityTo: 0.02, stops: [0, 90] } },
      stroke: { curve: 'smooth', width: 2 },
      xaxis: { type: 'datetime', labels: { style: { colors: '#555', fontSize: '10px' }, datetimeFormatter: { hour: 'HH:mm', minute: 'HH:mm:ss' } }, axisBorder: { show: false }, axisTicks: { show: false } },
      yaxis: { labels: { style: { colors: '#555', fontSize: '10px' }, formatter: v => v.toFixed(0) + ' W' }, min: 0 },
      grid: GRID_OPTS,
      tooltip: { ...TOOLTIP_DARK, x: { format: 'HH:mm:ss' } },
      dataLabels: { enabled: false }
    };

    // Fix #3: inizializza le chart solo se ApexCharts √® disponibile (CDN offline ‚Üí degradazione graceful)
    let chartPower  = null;
    let chartPanels = null;

    if (typeof ApexCharts !== 'undefined') {
      chartPower = new ApexCharts(document.getElementById('chart-power'), chartPowerOpts);
      chartPower.render();

      // --- Chart 2: per-panel bar chart ---
      const chartPanelsOpts = {
        chart: { ...CHART_DARK, type: 'bar', height: 180 },
        series: [{ name: 'W', data: [] }],
        colors: ['#42a5f5'],
        plotOptions: { bar: { horizontal: true, barHeight: '65%', borderRadius: 4, distributed: true } },
        legend: { show: false },
        xaxis: { labels: { style: { colors: '#555', fontSize: '10px' }, formatter: v => v + ' W' }, min: 0 },
        yaxis: { labels: { style: { colors: '#999', fontSize: '11px', fontWeight: 600 } } },
        grid: GRID_OPTS,
        tooltip: { ...TOOLTIP_DARK, y: { formatter: v => v + ' W' } },
        dataLabels: { enabled: false }
      };
      chartPanels = new ApexCharts(document.getElementById('chart-panels'), chartPanelsOpts);
      chartPanels.render();
    } else {
      // CDN non raggiungibile: nasconde la sezione chart per evitare elementi vuoti
      const row = document.getElementById('charts-row');
      if (row) {
        row.style.display = 'none';
        const msg = document.createElement('p');
        msg.style.cssText = 'color:var(--muted);font-size:.8rem;margin-top:8px';
        msg.textContent = '‚ö† Grafici non disponibili (libreria ApexCharts non caricata).';
        row.parentNode.insertBefore(msg, row.nextSibling);
      }
    }

    // helper: watt ‚Üí colour string for bars
    function barColor(w) {
      const f = Math.max(0, Math.min(1, w / MAX_WATT));
      if (f < 0.5) return lerpRGB([100,100,100], [240,165,0], f * 2);
      return lerpRGB([240,165,0], [76,175,80], (f - 0.5) * 2);
    }

    // called after every WS message
    function updateCharts() {
      if (!chartPower || !chartPanels) return; // Fix #3: chart non disponibili
      // Chart 1 ‚Äî total power point
      const vals = Object.values(data_map);
      const tot = vals.reduce((s,d) => s + (d.watt||0), 0);
      powerHistory.push({ x: Date.now(), y: tot });
      if (powerHistory.length > MAX_HIST) powerHistory.shift();
      chartPower.updateSeries([{ name: 'Totale W', data: [...powerHistory] }], false);

      // Chart 2 ‚Äî per panel sorted by label/id
      const sorted = vals.slice().sort((a,b) => {
        const la = a.panel || a.barcode || a.addr || '';
        const lb = b.panel || b.barcode || b.addr || '';
        return la.localeCompare(lb, undefined, { numeric: true });
      });
      const cats   = sorted.map(d => d.panel || d.barcode || d.addr || '?');
      const watts  = sorted.map(d => d.watt || 0);
      const colors = watts.map(w => barColor(w));
      chartPanels.updateOptions({ xaxis: { categories: cats }, colors }, false, false);
      chartPanels.updateSeries([{ name: 'W', data: watts }], false);

      // Adjust bar chart height based on number of panels
      const h = Math.max(160, sorted.length * 28 + 40);
      if (document.getElementById('chart-panels').style.height !== h + 'px') {
        chartPanels.updateOptions({ chart: { height: h } }, false, false);
        chartPower.updateOptions({ chart: { height: h } }, false, false);
      }
    }
  </script>
</body>
</html>
